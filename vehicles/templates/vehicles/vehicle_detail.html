{% extends 'vehicles/base.html' %}
{% load static %}

{% block title %}Detalle del Vehículo - {{ vehicle.plate }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-car"></i> Detalle del Vehículo</h2>
                <a href="{% url 'vehicle_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Información del Vehículo -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Información del Vehículo</h5>
                </div>
                <div class="card-body">
                    {% if vehicle.photo %}
                    <div class="text-center mb-3">
                        <img src="{{ vehicle.photo.url }}" alt="{{ vehicle.plate }}" class="img-fluid rounded" style="max-height: 200px;">
                    </div>
                    {% endif %}
                    
                    <table class="table table-borderless">
                        <tr>
                            <th width="40%">Placa:</th>
                            <td><strong class="text-success">{{ vehicle.plate }}</strong></td>
                        </tr>
                        <tr>
                            <th>Marca:</th>
                            <td>{{ vehicle.brand }}</td>
                        </tr>
                        <tr>
                            <th>Modelo:</th>
                            <td>{{ vehicle.model }}</td>
                        </tr>
                        <tr>
                            <th>Año:</th>
                            <td>{{ vehicle.year }}</td>
                        </tr>
                        {% if vehicle.station %}
                        <tr>
                            <th>Estación:</th>
                            <td><span class="badge bg-info">{{ vehicle.station }}</span></td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Estado:</th>
                            <td>
                                {% if vehicle.status == 'Active' %}
                                    <span class="badge bg-success">Activo</span>
                                {% elif vehicle.status == 'Maintenance' %}
                                    <span class="badge bg-warning">Mantenimiento</span>
                                {% else %}
                                    <span class="badge bg-danger">Fuera de servicio</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>

                    <div class="mt-3 d-flex gap-2 flex-wrap">
                        <a href="{% url 'vehicle_history' vehicle.pk %}" class="btn btn-info btn-sm">
                            <i class="fas fa-history"></i> Historial
                        </a>
                        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#qrModal">
                            <i class="fas fa-qrcode"></i> Ver QR
                        </button>
                        <a href="{% url 'vehicle_update' vehicle.pk %}" class="btn btn-warning btn-sm">
                            <i class="fas fa-edit"></i> Editar
                        </a>
                        <a href="{% url 'vehicle_delete' vehicle.pk %}" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i> Eliminar
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Documentos -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-file-alt"></i> Documentos</h5>
                    <a href="{% url 'document_add' %}?vehicle={{ vehicle.id }}" class="btn btn-sm btn-light">
                        <i class="fas fa-plus"></i> Agregar
                    </a>
                </div>
                <div class="card-body">
                    {% if documents %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Vencimiento</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in documents %}
                                <tr>
                                    <td>{{ doc.doc_type.name }}</td>
                                    <td>{{ doc.expiry_date|date:"d/m/Y" }}</td>
                                    <td>
                                        {% if doc.is_expired %}
                                            <span class="badge bg-danger">Vencido</span>
                                        {% else %}
                                            <span class="badge bg-success">Vigente</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">No hay documentos registrados</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Checklists -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #80AD46, #6B9239); color: white;">
                    <h5 class="mb-0"><i class="fas fa-clipboard-check"></i> Checklists de Inspección</h5>
                    <button type="button" class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#checklistModal">
                        <i class="fas fa-plus"></i> Nuevo Checklist
                    </button>
                </div>
                <div class="card-body">
                    {% if checklists %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Conductor</th>
                                    <th>Estación</th>
                                    <th>Estado General</th>
                                    <th>Odómetro</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for checklist in checklists %}
                                <tr>
                                    <td>{{ checklist.inspection_date|date:"d/m/Y H:i" }}</td>
                                    <td>{{ checklist.driver_name }}</td>
                                    <td>{{ checklist.station|default:"-" }}</td>
                                    <td>
                                        {% if checklist.overall_status == 'Bueno' %}
                                            <span class="badge bg-success">Bueno</span>
                                        {% elif checklist.overall_status == 'Regular' %}
                                            <span class="badge bg-warning">Regular</span>
                                        {% else %}
                                            <span class="badge bg-danger">Malo</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ checklist.odometer_reading }} km</td>
                                    <td>
                                        <a href="{% url 'checklist_detail' checklist.pk %}" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-clipboard-check" style="font-size: 3rem; color: #cbd5e1;"></i>
                        <p class="text-muted mt-2">No hay checklists registrados</p>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#checklistModal">
                            <i class="fas fa-plus"></i> Crear el primero
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Historial de Mantenimientos -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-warning d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-wrench"></i> Historial de Mantenimientos</h5>
                    <a href="{% url 'maintenance_add' %}" class="btn btn-sm btn-dark">
                        <i class="fas fa-plus"></i> Agregar
                    </a>
                </div>
                <div class="card-body">
                    {% if maintenances %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Estado</th>
                                    <th>Taller</th>
                                    <th>Costo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for maint in maintenances %}
                                <tr>
                                    <td>{{ maint.detection_date|date:"d/m/Y" }}</td>
                                    <td>{{ maint.maintenance_type.name }}</td>
                                    <td>
                                        {% if maint.status == 'Detectado' %}
                                            <span class="badge bg-warning">{{ maint.status }}</span>
                                        {% elif maint.status == 'Cotizado' %}
                                            <span class="badge bg-info">{{ maint.status }}</span>
                                        {% elif maint.status == 'Aprobado' %}
                                            <span class="badge bg-primary">{{ maint.status }}</span>
                                        {% elif maint.status == 'Completado' %}
                                            <span class="badge bg-success">{{ maint.status }}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ maint.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ maint.workshop.name|default:"-" }}</td>
                                    <td>
                                        {% if maint.cost %}
                                            ${{ maint.cost }}
                                        {% elif maint.estimated_cost %}
                                            ~${{ maint.estimated_cost }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'maintenance_detail' maint.pk %}" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">No hay mantenimientos registrados</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal QR Code -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #80AD46, #6B9239); color: white;">
                <h5 class="modal-title"><i class="fas fa-qrcode"></i> Código QR - {{ vehicle.plate }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <img src="{% url 'vehicle_qr' vehicle.pk %}" alt="QR {{ vehicle.plate }}" class="img-fluid" style="max-width: 300px;">
                </div>
                <div class="alert alert-info">
                    <strong>Información del QR:</strong><br>
                    Placa: {{ vehicle.plate }}<br>
                    Marca: {{ vehicle.brand }} {{ vehicle.model }}<br>
                    Año: {{ vehicle.year }}<br>
                    Estado: {{ vehicle.status }}<br>
                    Estación: {{ vehicle.station|default:"N/A" }}
                </div>
                <a href="{% url 'vehicle_qr' vehicle.pk %}" class="btn btn-success" download="qr_{{ vehicle.plate }}.png">
                    <i class="fas fa-download"></i> Descargar QR
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear Checklist -->
<div class="modal fade" id="checklistModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #80AD46, #6B9239); color: white;">
                <h5 class="modal-title"><i class="fas fa-clipboard-check"></i> Nuevo Checklist - {{ vehicle.plate }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'checklist_create' %}">
                {% csrf_token %}
                <input type="hidden" name="vehicle" value="{{ vehicle.id }}">
                <input type="hidden" name="from_detail" value="1">
                
                <div class="modal-body">
                    <!-- Información General -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label class="form-label"><i class="fas fa-user"></i> Nombre del Conductor</label>
                            <input type="text" name="driver_name" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label"><i class="fas fa-map-marker-alt"></i> Estación</label>
                            <select name="station" class="form-select">
                                <option value="">Seleccionar...</option>
                                <option value="Aguascalientes">Aguascalientes</option>
                                <option value="Baja California">Baja California</option>
                                <option value="Baja California Sur">Baja California Sur</option>
                                <option value="Campeche">Campeche</option>
                                <option value="Chiapas">Chiapas</option>
                                <option value="Chihuahua">Chihuahua</option>
                                <option value="Ciudad de México" selected>Ciudad de México</option>
                                <option value="Coahuila">Coahuila</option>
                                <option value="Colima">Colima</option>
                                <option value="Durango">Durango</option>
                                <option value="Estado de México">Estado de México</option>
                                <option value="Guanajuato">Guanajuato</option>
                                <option value="Guerrero">Guerrero</option>
                                <option value="Hidalgo">Hidalgo</option>
                                <option value="Jalisco">Jalisco</option>
                                <option value="Michoacán">Michoacán</option>
                                <option value="Morelos">Morelos</option>
                                <option value="Nayarit">Nayarit</option>
                                <option value="Nuevo León">Nuevo León</option>
                                <option value="Oaxaca">Oaxaca</option>
                                <option value="Puebla">Puebla</option>
                                <option value="Querétaro">Querétaro</option>
                                <option value="Quintana Roo">Quintana Roo</option>
                                <option value="San Luis Potosí">San Luis Potosí</option>
                                <option value="Sinaloa">Sinaloa</option>
                                <option value="Sonora">Sonora</option>
                                <option value="Tabasco">Tabasco</option>
                                <option value="Tamaulipas">Tamaulipas</option>
                                <option value="Tlaxcala">Tlaxcala</option>
                                <option value="Veracruz">Veracruz</option>
                                <option value="Yucatán">Yucatán</option>
                                <option value="Zacatecas">Zacatecas</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label"><i class="fas fa-tachometer-alt"></i> Odómetro (km)</label>
                            <input type="number" name="odometer_reading" class="form-control" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label"><i class="fas fa-gas-pump"></i> Nivel Combustible</label>
                            <select name="fuel_level" class="form-select" required>
                                <option value="Lleno">Lleno</option>
                                <option value="3/4">3/4</option>
                                <option value="1/2">1/2</option>
                                <option value="1/4">1/4</option>
                                <option value="Vacío">Vacío</option>
                            </select>
                        </div>
                    </div>

                    <hr>

                    <!-- Checklist Items -->
                    <h6 class="mb-3"><i class="fas fa-tasks"></i> Inspección del Vehículo</h6>
                    <div class="row">
                        <!-- Columna 1 -->
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Condición de Llantas</label>
                                <select name="tires_condition" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Presión de Llantas</label>
                                <select name="tires_pressure" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Luces</label>
                                <select name="lights" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Espejos</label>
                                <select name="mirrors" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Parabrisas</label>
                                <select name="windshield" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Limpiaparabrisas</label>
                                <select name="wipers" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                        </div>

                        <!-- Columna 2 -->
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Daños en Carrocería</label>
                                <select name="body_damage" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Cinturones de Seguridad</label>
                                <select name="seat_belts" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Claxon</label>
                                <select name="horn" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Luces del Tablero</label>
                                <select name="dashboard_lights" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Aire Acondicionado</label>
                                <select name="air_conditioning" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Frenos</label>
                                <select name="brakes" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                        </div>

                        <!-- Columna 3 -->
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Motor</label>
                                <select name="engine" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Nivel de Aceite</label>
                                <select name="oil_level" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Nivel de Refrigerante</label>
                                <select name="coolant_level" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Batería</label>
                                <select name="battery" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Extintor</label>
                                <select name="fire_extinguisher" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Botiquín</label>
                                <select name="first_aid_kit" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Triángulos de Seguridad</label>
                                <select name="warning_triangles" class="form-select" required>
                                    <option value="Bueno">Bueno</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Malo">Malo</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <label class="form-label"><i class="fas fa-comment"></i> Observaciones</label>
                            <textarea name="observations" class="form-control" rows="3" placeholder="Comentarios adicionales..."></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Guardar Checklist
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
